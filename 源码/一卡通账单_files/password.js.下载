define(function(require, exports, module) {
    var utils = require('utils');
    var bs = require('./passwordBs');
    var viewConfig = {
        initialize: function(html, cardnum) {
        	
        	var self = this;
        	
			var mainView = utils.loadCompiledPage('passwordPage', require);
			
			html.html(mainView.render(), true);
			
			// 初始化tab页
			self.initTab(cardnum);
			
			self.eventMap = {
			
				// 修改交易密码提交
    			'[data-action=submitPayPwd]': self.submitPayPwdAction,
    			
    			// 修改交易密码重置
    			'[data-action=resetPayPwd]': self.resetPayPwdAction,
    			
    			// 修改查询密码提交
    			'[data-action=submitQueryPwd]': self.submitQueryPwdAction,
    			
    			// 修改查询密码重置
    			'[data-action=resetQueryPwd]': self.resetQueryPwdAction
    			
            };
        },
        
        // 初始化tab页
        initTab: function(cardnum) {
            
        	var self = this;
        	
            $('#jqxTabs').jqxTabs({
                width: '100%',
                height: 'auto',
                position: 'top'
            }).on('selected', function(event) {
            	
                var selectedTab = event.args.item; //tab序号
                
                //加载点击的tab页
                switch (selectedTab) {
                    case 0:
                        self.renderPwdForm($('#payPwdForm'), cardnum);
                        break;
                    case 1:
                        self.renderPwdForm($('#queryPwdForm'), cardnum);
                        break;
                    default:
                        break;
                }
            });
            
            // 渲染修改交易密码表单
            self.renderPwdForm($('#payPwdForm'), cardnum);
            
        },
        
        // 渲染修改密码表单
        renderPwdForm: function($form, cardnum) {
        	
        	// 初始化表单
            bs.initForm($form);
            
            $('[data-name=CARD_NO]', $form).text(cardnum).data('value', cardnum);
            $('[data-name=CARD_OLD_PWD]', $form).attr('type','password');
            $('[data-name=CARD_NEW_PWD]', $form).attr('type','password');
            $('[data-name=CARD_CONFIRM_PWD]', $form).attr('type','password');
        },
        
        // 提交交易密码
        submitPayPwdAction: function() {
        	
        	this.submitAction($('#payPwdForm'), 'PAY');
        	
        },
        
        // 提交查询密码
        submitQueryPwdAction: function() {
        	
        	this.submitAction($('#queryPwdForm'), 'QUERY');
        	
        },
        
        // 提交
        submitAction: function($form, type) {
        	
        	// 校验字段
    		var valid = $form.emapValidate('validate');
    		
    		// 如果校验不通过则返回false
            if (!valid) {
            	
                return false;
                
            }
            
            var formData = $form.emapForm('getValue');
            
            if (formData.CARD_NEW_PWD !== formData.CARD_CONFIRM_PWD) {
            	BH_UTILS.bhDialogDanger({
            	    title: '提示',
            	    content: '确认密码与新密码不一致！',
            	    buttons:[
            	             {
            	                 text:'确定',
            	                 callback:function(){
            	                     
            	                 }
            	             }
            	         ]
            	});
            	return false;
            	
            }
            formData.TYPE = type;
            
            bs.changePwd().done(function(resp) {

                if (resp.code === '0') {
                	
                	$.bhTip({ content : resp.msg, state : 'success', hideWaitTime : 1000 });
                    
                } else {
                	
                	BH_UTILS.bhDialogDanger({
                	    title: '提示',
                	    content: resp.msg,
                	    buttons:[
                	             {
                	                 text:'确定',
                	                 callback:function(){
                	                     
                	                 }
                	             }
                	         ]
                	});
                }
            });
        },
        
        // 重置交易密码
        resetPayPwdAction: function() {
        	
        	this.resetAction($('#payPwdForm'));
        	
        },
        
        // 重置查询密码
        resetQueryPwdAction: function() {
        	
        	this.resetAction($('#queryPwdForm'));
        	
        },
        
        // 重置
        resetAction: function($form) {

        	$form.emapForm('clear');
        	$form.emapForm('clearValidateInfo');
        	
        }
        
    };
    return viewConfig;
});